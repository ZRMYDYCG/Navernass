# Narraverse 项目开发规范

## 项目概述

Narraverse 是一个小说创作平台，专注于为创作者打造舒适的创作环境。项目使用 Next.js 15 + TypeScript + Supabase + 硅基流动 AI 构建。

### 核心功能

- 小说创作和管理
- 章节编辑和管理
- AI 智能写作助手（续写、润色、咨询）
- 对话式 AI 助手
- 富文本编辑器（基于 TipTap）

## 技术栈

### 前端框架
- **Next.js 15.5.5** - App Router
- **React 19.1.0**
- **TypeScript 5**

### UI 库
- **Radix UI** - 无样式组件库
- **Tailwind CSS 4** - 样式框架
- **Lucide React** - 图标库
- **Framer Motion** - 动画库

### 编辑器
- **TipTap** - 富文本编辑器
- **ProseMirror** - 编辑器底层

### 后端服务
- **Supabase** - 数据库和认证
- **硅基流动 (Silicon Flow)** - AI 服务提供商

### 开发工具
- **ESLint** - 代码检查（@antfu/eslint-config）
- **Lefthook** - Git Hooks 管理
- **Commitlint** - Commit 规范
- **Release-it** - 版本发布

## 项目结构

```
narraverse-next-mvp/
├── app/                      # Next.js App Router
│   ├── (main)/              # 主要应用路由
│   │   ├── chat/            # 聊天页面
│   │   ├── novels/          # 小说管理
│   │   └── trash/           # 回收站
│   ├── (marketing)/         # 营销页面
│   ├── (writing)/           # 写作编辑器
│   └── api/                 # API 路由
├── components/              # 共享组件
│   ├── ui/                  # UI 基础组件
│   └── tiptap/              # 编辑器组件
├── lib/                     # 工具库
│   └── supabase/           # Supabase SDK
│       └── sdk/
│           ├── services/    # 业务逻辑层
│           ├── utils/       # 工具函数
│           └── types.ts     # 类型定义
├── providers/               # React Providers
└── migrations/              # 数据库迁移
```

## 代码规范

### API 开发规范

#### 1. 创建 API 服务的标准流程

**步骤 1: 创建 Service 类**

```typescript
// lib/supabase/sdk/services/new-feature.service.ts
export class NewFeatureService {
  async getList() {
    // 业务逻辑
  }
  
  async create(data: CreateData) {
    // 业务逻辑
  }
}
```

**步骤 2: 创建 Route Handler**

```typescript
// app/api/new-feature/route.ts
import { withErrorHandler } from '@/lib/supabase/sdk/utils/handler'
import { ApiResponseBuilder } from '@/lib/supabase/sdk/utils/response'
import { NewFeatureService } from '@/lib/supabase/sdk/services/new-feature.service'

const service = new NewFeatureService()

export const GET = withErrorHandler(async (req: NextRequest) => {
  const data = await service.getList()
  return ApiResponseBuilder.success(data)
})
```

**步骤 3: 创建客户端 API**

```typescript
// lib/supabase/sdk/new-feature.ts
import { apiClient } from './client'

export const newFeatureApi = {
  getList: () => apiClient.get('/api/new-feature'),
  create: (data: CreateData) => apiClient.post('/api/new-feature', data),
}
```

#### 2. API 响应格式

**成功响应：**

```typescript
{
  success: true,
  data: {},
  meta?: {
    page?: number
    pageSize?: number
    total?: number
  }
}
```

**错误响应：**

```typescript
{
  success: false,
  error: {
    code: string
    message: string
    details?: any
  }
}
```

#### 3. 错误处理

- 所有 API Route Handler 必须使用 `withErrorHandler` 包装
- 使用 `ApiResponseBuilder` 构建响应
- 错误信息要清晰明确，包含错误代码

### 组件开发规范

#### 1. 组件文件结构

- 组件文件使用 kebab-case 命名：`chat-sidebar.tsx`
- 组件目录使用下划线前缀：`_components/`
- 组件导出使用 PascalCase

#### 2. 组件组织

```
feature/
├── _components/           # 组件目录
│   ├── component-a.tsx
│   └── component-b.tsx
├── _utils/               # 工具函数
├── config.ts            # 配置文件
├── page.tsx             # 页面组件
└── types.ts             # 类型定义
```

#### 3. UI 组件使用

- 使用 `components/ui/` 中的基础组件
- 不要自定义 loading 组件，使用统一的 `Spinner` 和骨架屏
- UI 组件路径：`components/ui/spinner.tsx`

### 样式规范

#### 1. 主题限制

**重要：** 当前 MVP 版本，只使用黑、灰、白三种颜色。

- 不要使用其他颜色主题
- 保持设计的一致性
- 避免后期样式溯源问题

#### 2. Tailwind CSS

- 使用 Tailwind CSS 4
- 遵循项目的 Tailwind 配置
- 使用语义化的类名

### TypeScript 规范

#### 1. 类型定义

- 类型文件放在 `types.ts` 或 `types.tsx` 中
- 使用 TypeScript 严格模式
- 避免使用 `any`，必要时使用 `eslint-disable` 注释

#### 2. 导入路径

- 使用 `@/` 别名导入
- 相对路径用于同目录文件
- 绝对路径用于跨目录导入

### Git 提交规范

#### Commit 格式

```
<type>(<scope>): <subject>

<body>

<footer>
```

#### Type 类型

- `feat` - 新功能
- `fix` - 修复 bug
- `docs` - 文档变更
- `style` - 代码格式（不影响代码运行）
- `refactor` - 重构
- `perf` - 性能优化
- `test` - 增加测试
- `build` - 构建过程或辅助工具的变动
- `ci` - CI 配置文件和脚本的变动
- `chore` - 其他不修改 src 或测试文件的变动
- `revert` - 回滚 commit

#### 示例

```bash
feat(chat): 添加流式消息支持
fix(editor): 修复章节保存问题
docs(readme): 更新 API 文档
```

## 架构模式

### 服务层架构

```
API Route Handler
    ↓
Service Layer (业务逻辑)
    ↓
Supabase Client (数据访问)
```

### 数据流

1. **客户端请求** → API Route Handler
2. **Route Handler** → Service Layer
3. **Service Layer** → Supabase Client
4. **响应** → ApiResponseBuilder → 客户端

### 错误处理流程

1. Service Layer 抛出错误
2. `withErrorHandler` 捕获错误
3. `ApiResponseBuilder.error` 构建错误响应
4. 返回统一的错误格式

## AI 服务集成

### 硅基流动 (Silicon Flow)

- 服务类：`lib/supabase/sdk/services/silicon-flow.service.ts`
- API 路由：`app/api/chat/send/route.ts`（非流式）
- API 路由：`app/api/chat/stream/route.ts`（流式）

### AI 模式

- **Ask** - 询问模式，对话咨询
- **Agent** - 智能体模式，复杂任务
- **Continue** - 续写模式，续写故事
- **Polish** - 润色模式，优化文字

### 系统提示词

```
你是一个专业的小说创作助手，擅长帮助用户构思情节、塑造角色、续写故事。请用温暖、鼓励的语气与用户交流，提供有创意的建议。
```

## 数据库规范

### Supabase 使用

- 使用 Supabase Client 进行数据访问
- Service Layer 封装数据库操作
- 使用类型安全的查询

### 迁移管理

- 迁移文件放在 `migrations/` 目录
- 使用 `supabase db push` 和 `supabase db pull` 管理迁移

## 开发流程

### 1. 开发新功能

1. 创建 Service 类（如需要）
2. 创建 API Route Handler
3. 创建客户端 API
4. 创建前端组件
5. 编写类型定义
6. 测试功能

### 2. 代码检查

```bash
# ESLint 检查
pnpm lint

# ESLint 自动修复
pnpm lint:fix

# TypeScript 类型检查
pnpm typecheck
```

### 3. Git 工作流

1. 创建功能分支
2. 开发功能
3. 提交代码（使用 `pnpm commit`）
4. 推送代码
5. 创建 Pull Request

### 4. 版本发布

```bash
# 发布补丁版本
pnpm release:patch

# 发布小版本
pnpm release:minor

# 发布大版本
pnpm release:major

# 发布 Beta 版本
pnpm release:beta
```

## 重要约定

### 1. 加载状态

- **不要自定义 loading 组件**
- 使用统一的 `Spinner` 组件
- 使用统一的骨架屏组件
- 特殊业务场景除外

### 2. 错误处理

- 所有 API 必须使用 `withErrorHandler`
- 错误信息要友好清晰
- 记录错误日志

### 3. 类型安全

- 避免使用 `any`
- 使用 TypeScript 严格模式
- 为所有数据定义类型

### 4. 组件复用

- 优先使用 `components/ui/` 中的基础组件
- 保持组件的单一职责
- 提取可复用的逻辑

### 5. 性能优化

- 使用 Next.js 的服务器组件
- 合理使用客户端组件
- 优化图片和资源加载
- 使用流式渲染（如需要）

## 环境变量

### 必需的环境变量

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=

# 硅基流动 AI
SILICON_FLOW_API_KEY=
SILICON_FLOW_BASE_URL=https://api.siliconflow.cn/v1
SILICON_FLOW_MODEL=deepseek-chat
```

### 安全注意事项

- **不要将 API Key 提交到代码仓库**
- 使用 `.env.local` 存储本地环境变量
- 使用环境变量管理工具管理生产环境变量

## 相关文档

- [README.md](../README.md) - 项目概述和开发指南
- [AGENTS.md](../AGENTS.md) - AI Agents 配置文档
- [prompts.md](../prompts.md) - 提示词文档
- [app/api/api-doc.md](../app/api/api-doc.md) - API 接口文档

## 开发注意事项

1. **代码格式**：使用 ESLint 自动格式化，不要使用 Prettier
2. **提交信息**：使用 `pnpm commit` 进行规范化提交
3. **类型检查**：提交前运行 `pnpm typecheck` 确保类型正确
4. **主题颜色**：只使用黑、灰、白三种颜色
5. **加载状态**：使用统一的加载组件，不要自定义
6. **错误处理**：所有 API 必须使用错误处理中间件
7. **类型安全**：避免使用 `any`，保持类型安全

## 快速参考

### 创建新的 API 端点

```typescript
// 1. 创建 Service
export class MyService {
  async getData() {}
}

// 2. 创建 Route Handler
export const GET = withErrorHandler(async (req) => {
  const service = new MyService()
  const data = await service.getData()
  return ApiResponseBuilder.success(data)
})

// 3. 创建客户端 API
export const myApi = {
  getData: () => apiClient.get('/api/my-endpoint'),
}
```

### 创建新的组件

```typescript
// components/my-component.tsx
export function MyComponent() {
  return <div>My Component</div>
}
```

### 使用 UI 组件

```typescript
import { Button } from '@/components/ui/button'
import { Spinner } from '@/components/ui/spinner'

export function MyComponent() {
  return (
    <Button>
      <Spinner />
      Loading
    </Button>
  )
}
```

## 常见问题

### Q: 如何添加新的 API 端点？

A: 按照"创建 API 服务的标准流程"进行操作，确保使用 `withErrorHandler` 和 `ApiResponseBuilder`。

### Q: 如何添加新的 UI 组件？

A: 优先使用 `components/ui/` 中的基础组件，如果需要新组件，参考现有组件的实现。

### Q: 如何处理错误？

A: 使用 `withErrorHandler` 包装 Route Handler，使用 `ApiResponseBuilder.error` 构建错误响应。

### Q: 如何提交代码？

A: 使用 `pnpm commit` 进行规范化提交，遵循 Commit 规范。

### Q: 可以使用其他颜色吗？

A: 当前 MVP 版本只使用黑、灰、白三种颜色，不要使用其他颜色主题。
